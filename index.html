<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="color-scheme" content="light">
<meta name="theme-color" content="#eff7ff">

<title>Drug repurposing Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<style>
  /* ========= Design tokens (all colors route through here) ========= */
  :root{
    --bg:            #eff7ff;  /* page background: solid light blue */
    --text:          #2d3954;
    --muted:         #8a95a6;

    --panel:         #ffffff;  /* cards/panels/table bg */
    --panel-2:       #fbfdff;  /* ultra-light panel tint */

    --accent:        #6aa9ff;  /* primary accent (buttons/links/active) */
    --accent-2:      #6ed39a;  /* secondary accent */

    --border:        #e3edf7;  /* card/table border */
    --border-soft:   #f1f6fb;  /* row dividers */

    /* Table-specific tokens */
    --thead:         #f4f9ff;  /* header bg */
    --zebra:         #fbfdff;  /* even row bg */
    --hover:         #eef6ff;  /* row hover */

    --link:          #3f89e9;
    --link-hover:    #2e6fd1;

    --shadow:        0 2px 10px rgba(0,0,0,.04);
    --radius:        14px;
  }

  /* ========= Page layout ========= */
  html,body{height:100%}
  body{
    margin:0;
    font: 14px/1.55 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    color:var(--text);
    background: var(--bg) !important; /* force solid light blue (no gradient) */
    padding: 28px clamp(16px, 3vw, 32px);
  }

  h1{
    margin:0 0 14px;
    font-size: clamp(18px, 2.4vw, 26px);
    letter-spacing:.2px;
    font-weight: 600;
    color: var(--accent);
  }

  /* ========= Toolbar ========= */
  .bar{
    display:flex; flex-wrap:wrap; gap:10px 12px; align-items:center;
    margin: 10px 0 16px;
    background: var(--panel);
    border:1px solid var(--border);
    border-radius: calc(var(--radius) + 4px);
    padding: 10px;
    box-shadow: var(--shadow);
  }

  /* Inputs & buttons */
  .bar input[type="text"], .bar input[type="url"]{
    flex:1 1 280px; min-width: 220px; max-width: 520px;
    border:1px solid var(--border); background:#fff; color:var(--text);
    padding:10px 12px; border-radius:12px; outline: none;
    transition: border-color .15s, box-shadow .15s, background .15s;
  }
  .bar input[type="text"]::placeholder,
  .bar input[type="url"]::placeholder{ color:var(--muted) }
  .bar input[type="text"]:focus,
  .bar input[type="url"]:focus{
    border-color: var(--accent);
    box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 30%, transparent);
    background: color-mix(in oklab, #fff 90%, var(--accent) 10%);
  }

  .bar input[type="file"]{
    padding: 10px 12px;
    border:1px dashed var(--border);
    border-radius:12px;
    background:#fff;
    color:var(--muted);
  }

  button{
    padding:10px 14px;
    border:1px solid color-mix(in oklab, var(--accent) 60%, transparent);
    background: var(--accent);
    color:#0f1f3a;
    border-radius:12px;
    cursor:pointer;
    transition: transform .06s ease, box-shadow .15s ease, filter .15s ease;
    box-shadow: 0 3px 10px rgba(0,0,0,.06);
  }
  button:hover{ transform: translateY(-1px); filter: brightness(1.03); box-shadow: 0 6px 18px rgba(0,0,0,.08) }
  button:active{ transform: translateY(0); box-shadow: 0 3px 10px rgba(0,0,0,.06) }

  /* ========= Table shell ========= */
  .table-wrap{
    max-width:100%;
    overflow:auto;
    border:1px solid var(--border);
    border-radius: var(--radius);
    background: var(--panel);
    box-shadow: var(--shadow);
    position: relative;
  }
  .table-wrap::before,
  .table-wrap::after{
    content:"";
    position: sticky; top:0; bottom:0; width:24px; pointer-events:none; z-index:1;
  }
  .table-wrap::before{ left:0; background: linear-gradient(90deg, var(--panel) 0%, transparent 100%) }
  .table-wrap::after{ right:0; background: linear-gradient(270deg, var(--panel) 0%, transparent 100%) }

  /* ========= Table ========= */
  table{ border-collapse: collapse; width:100%; font-size: 14px; }

  thead th{
    position: sticky; top:0; z-index: 2;
    background: var(--thead) !important;       /* token-based */
    border-bottom:1px solid var(--border);
    color: var(--text);
    white-space: nowrap;
    padding: 10px 12px;
    text-align: left;
    letter-spacing:.2px;
    cursor: pointer;
    user-select: none;
  }

  thead th::after{
    content:"";
    display:inline-block; margin-left:8px;
    width: 0; height: 0; border-left:5px solid transparent; border-right:5px solid transparent;
    border-top:6px solid var(--accent); opacity:.45; transform: translateY(-2px);
  }
  thead th:hover{ color: color-mix(in oklab, var(--accent) 80%, var(--text)); }
  thead th:hover::after{ opacity:.7 }

  tbody tr{ transition: background .12s ease, box-shadow .12s ease }
  tbody tr:nth-child(even){ background: var(--zebra) !important; }
  tbody tr:hover{
    background: var(--hover) !important;
    box-shadow: inset 0 1px 0 rgba(0,0,0,.03), inset 0 -1px 0 rgba(0,0,0,.03);
  }

  th, td{
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-soft);
    vertical-align: top;
  }

  td a{
    color: var(--link);
    text-decoration: none;
    border-bottom: 1px dashed color-mix(in oklab, var(--link) 60%, transparent);
    padding-bottom:1px;
  }
  td a:hover{
    color: var(--link-hover);
    border-bottom-style: solid;
  }

  .muted{
    color: var(--muted);
    font-size: 12px;
    margin-top: 10px;
    padding-left: 2px;
  }
  .hidden{ display:none }

  @media (max-width: 700px){
    .bar{ padding: 8px }
    .bar input[type="text"], .bar input[type="url"]{ flex:1 1 100%; min-width: 0 }
    th, td{ padding: 9px 10px }
    table{ font-size: 13px }
  }
</style>


</head>
<body>
  <h1>Drug repurposing Viewer</h1>
  <div class="bar">
    <input id="search" type="text" placeholder="Filter rows (case-insensitive)..." />
    <input id="url" type="url" placeholder="Paste CSV URL (supports comma/semicolon/tab)"/>
    <button id="loadUrl">Load URL</button>
    <input id="file" type="file" accept=".csv,text/csv" />
  </div>
  <div class="table-wrap"><table id="tbl"><thead></thead><tbody></tbody></table></div>
  <div id="info" class="muted hidden"></div>


<script>
/* Force light appearance even if OS/browser is dark */
(function () {
  // Tell the browser we intend light UI colors (affects form controls, scrollbars, UA defaults)
  document.documentElement.style.colorScheme = 'light';

  // Safety: enforce light backgrounds in case an extension tries to invert
  const s = document.createElement('style');
  s.setAttribute('id', 'force-light');
  s.textContent = `
    html, body { background:#eff7ff !important; color:#223 !important; }
    .bar, .table-wrap, table, thead, tbody, tr, th, td { background:#ffffff !important; color:#223 !important; }
  `;
  document.head.appendChild(s);
})();
</script>


<script>



/* --- CSV parsing (quotes + , ; \t) --- */
function detectDelimiter(text){
  const sample = text.split(/\r?\n/).slice(0,20).join("\n");
  const counts = {",":0,";":0,"\t":0};
  for (const d of Object.keys(counts)){
    counts[d] = sample.split("\n")
      .map(line => (line.match(new RegExp(d === "\t" ? "\\t" : d.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),"g"))||[]).length)
      .reduce((a,b)=>a+b,0);
  }
  return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0] || ",";
}

function parseCSV(text, delimiter){
  delimiter = delimiter || detectDelimiter(text);
  const rows = [];
  let i=0, field="", inQuotes=false, row=[];
  while(i < text.length){
    const c = text[i], next = text[i+1];
    if (inQuotes){
      if (c === '"' && next === '"'){ field += '"'; i+=2; continue; }
      if (c === '"'){ inQuotes=false; i++; continue; }
      field += c; i++; continue;
    } else {
      if (c === '"'){ inQuotes=true; i++; continue; }
      if (c === delimiter){ row.push(field); field=""; i++; continue; }
      if (c === '\n'){ row.push(field); rows.push(row); row=[]; field=""; i++; continue; }
      if (c === '\r'){ i++; continue; }
      field += c; i++; continue;
    }
  }
  row.push(field); rows.push(row);
  if (rows.length && rows[rows.length-1].length===1 && rows[rows.length-1][0]==="") rows.pop();
  return rows;
}

/* --- State & DOM refs --- */
const tbl = document.getElementById('tbl');
const thead = tbl.querySelector('thead');
const tbody = tbl.querySelector('tbody');
const searchBox = document.getElementById('search');
const info = document.getElementById('info');

let data = [];     // array of objects
let columns = [];  // header names
let sortState = { key:null, dir:1 };

/* --- Convert rows to objects --- */
function rowsToObjects(rows){
  if (!rows.length) return {columns:[], data:[]};
  let cols = rows[0].map((h,i)=> (h && h.trim()) ? h.trim() : `col_${i+1}`);
  const seen = {};
  cols = cols.map(h => {
    const base = h || 'column';
    if (!seen[base]) { seen[base]=1; return base; }
    return `${base}_${++seen[base]}`;
  });
  const out = rows.slice(1).map(r=>{
    const obj={};
    cols.forEach((h,i)=> obj[h] = (r[i] ?? ''));
    return obj;
  });
  return {columns: cols, data: out};
}

/* --- Link helpers --- */
const rxPdbCore = /^[0-9][A-Za-z0-9]{3}$/;  // 3Q4U, 2PML

function extractPdbAndChain(raw){
  if (!raw) return null;
  const v = String(raw).trim();
  const cleaned = v.replace(/\.pdb$/i, "").replace(/^pdb[:/]/i, "").trim();
  const parts = cleaned.split(/[:._-]/).filter(Boolean);
  const pdbId = parts[0]?.toUpperCase();
  if (!pdbId || !rxPdbCore.test(pdbId)) return null;
  const chain = parts[1] && /^[A-Za-z0-9]{1,3}$/.test(parts[1]) ? parts[1] : null;
  return { pdbId, chain };
}

function makeLinkedNode(header, value){
  const td = document.createElement('td');
  const v = (value ?? "").toString().trim();
  const h = (header ?? "").toString().toLowerCase();

  if (!v){ td.textContent = ""; return td; }

  // 0) direct URL
  if (v.startsWith("http://") || v.startsWith("https://")){
    const a = document.createElement('a');
    a.href = v; a.textContent = v; a.target = "_blank"; a.rel="noopener noreferrer";
    td.appendChild(a); return td;
  }

  // 1) PubChem CID
  if (h.includes("pubchem") || (h.includes("cid") && !h.includes("acid"))){
    const a = document.createElement('a');
    a.href = `https://pubchem.ncbi.nlm.nih.gov/compound/${encodeURIComponent(v)}`;
    a.textContent = v; a.target="_blank"; a.rel="noopener noreferrer";
    td.appendChild(a); return td;
  }

  // 2) RCSB PDB for target/malaria (or any PDB-looking value)
  if (h === "pdb_target_id" || h === "malaria"){
    const pdb = extractPdbAndChain(v);
    if (pdb){
      const a = document.createElement('a');
      const chainParam = pdb.chain ? `?chainId=${encodeURIComponent(pdb.chain)}` : "";
      a.href = `https://www.rcsb.org/structure/${pdb.pdbId}${chainParam}`;
      a.textContent = v; a.target="_blank"; a.rel="noopener noreferrer";
      td.appendChild(a); return td;
    }
  }

  // 3) 3D Interaction → NGL viewer
  // note: `h` is already lowercased above
  if (h === "3d interaction" || h.includes("3d interaction")) {
    const a = document.createElement('a');

    // viewer page relative to index.html
    const viewerUrl = "./ngl/viewer.html";

    // file path relative to index.html (same repo)
    // ex: if v = "1VRW_A_3AM5_A_TCL.pdb"
    const pdbPath = `../MDpdb/${encodeURIComponent(v)}`;

    // pick format from extension, default to pdb
    const ext = (v.split('.').pop() || "").toLowerCase();
    const fmt = (ext === 'cif' || ext === 'mmcif') ? 'mmcif'
            : (ext === 'bcif') ? 'bcif'
            : (ext === 'sdf')  ? 'sdf'
            : (ext === 'mol2') ? 'mol2'
            : 'pdb';

    a.href = `${viewerUrl}?load=${encodeURIComponent(pdbPath)}&format=${encodeURIComponent(fmt)}`;
    a.textContent = v;
    a.target = "_blank";
    a.rel = "noopener noreferrer";
    td.appendChild(a);
    return td;
  }


    // 4) Gene ID → PlasmoDB
  if (h.toLowerCase().includes("gene id")) {
    if (v) {
      const a = document.createElement('a');
      a.href = `https://plasmodb.org/plasmo/app/record/gene/${encodeURIComponent(v)}`;
      a.textContent = v;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      td.appendChild(a);
    } else {
      td.textContent = ""; // keep cell empty if no gene id
    }
    return td;
  }


    // 6) plain text
    td.textContent = v; return td;
  }

/* --- Render table --- */
function renderTable(cols, rows){
  // clear header first
  thead.innerHTML = "";
  thead.style.background = '#f7fbff';   // light tint for header row
  tbody.style.background = '#ffffff';   // white background for table body

  // build header row
  const tr = document.createElement('tr');
  cols.forEach(c=>{
    const th = document.createElement('th');
    th.textContent = c;
    th.title = "Click to sort";
    th.style.background = '#f7fbff';    // force light header cell background
    th.style.color = '#223';            // dark readable text
    th.addEventListener('click', ()=> sortBy(c));
    tr.appendChild(th);
  });
  thead.appendChild(tr);

  // build body
  tbody.innerHTML = "";
  const frag = document.createDocumentFragment();
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.style.background = '#ffffff';   // default white row background
    cols.forEach(c=>{
      const td = makeLinkedNode(c, r[c]);
      td.style.background = '#ffffff'; // force white cells
      td.style.color = '#223';         // readable text
      tr.appendChild(td);
    });
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);

  // info
  info.classList.remove('hidden');
  info.textContent = `${rows.length.toLocaleString()} rows  •  ${cols.length} columns`;
}


/* --- Sort & Filter --- */
function sortBy(key){
  if (sortState.key === key){ sortState.dir *= -1; } else { sortState.key = key; sortState.dir = 1; }
  const dir = sortState.dir;
  const isNum = data.every(row => row[key] === "" || !isNaN(Number(row[key])));
  const sorted = [...filteredRows()].sort((a,b)=>{
    const va = a[key], vb = b[key];
    if (isNum){ return (Number(va||0) - Number(vb||0)) * dir; }
    return String(va).localeCompare(String(vb)) * dir;
  });
  renderTable(columns, sorted);
}

function filteredRows(){
  const q = searchBox.value.trim().toLowerCase();
  if (!q) return data;
  return data.filter(row => columns.some(c => String(row[c]).toLowerCase().includes(q)));
}

/* --- Loaders --- */
async function loadFromText(text){
  const rows = parseCSV(text);
  const {columns: cols, data: rowsObj} = rowsToObjects(rows);
  columns = cols; data = rowsObj;
  renderTable(columns, filteredRows());
}

async function loadFromURL(url){
  const res = await fetch(url, {cache:'no-store'});
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const txt = await res.text();
  await loadFromText(txt);
}

document.getElementById('loadUrl').addEventListener('click', async ()=>{
  const url = document.getElementById('url').value.trim();
  if (!url) return alert("Please paste a CSV URL.");
  try { await loadFromURL(url); }
  catch (e){ alert("Failed to load URL: " + e.message); }
});

document.getElementById('file').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if (!f) return;
  const txt = await f.text();
  await loadFromText(txt);
});

searchBox.addEventListener('input', ()=>{
  renderTable(columns, filteredRows());
});

/* --- Auto load a default CSV file from the same folder as index.html --- */
window.addEventListener("DOMContentLoaded", async () => {
  try {
    await loadFromURL("./Data.csv");   // change "data.csv" to your filename
  } catch (e) {
    console.error("Failed to auto-load CSV:", e);
  }
});

</script>
</body>
</html>
