<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Drug repurposing Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  /* ========= Design tokens ========= */
  :root{
    --bg: #0b0d10;
    --panel: #11151a;
    --panel-2: #0f1318;
    --text: #e8edf2;
    --muted: #9aa4af;
    --accent: #4da3ff;
    --accent-2: #7bd389;
    --border: #1f2730;
    --border-soft: #18202a;
    --shadow: 0 6px 24px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.35);
    --radius: 14px;
  }

  /* Light mode fallback if someone forces it */
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f7f7fb; --panel:#ffffff; --panel-2:#f9f9fd;
      --text:#1f2a37; --muted:#6b7280; --accent:#2563eb; --accent-2:#16a34a;
      --border:#e5e7eb; --border-soft:#eef0f4; --shadow:0 6px 20px rgba(31,41,55,.08),0 2px 6px rgba(31,41,55,.06);
    }
  }

  /* ========= Page layout ========= */
  html,body{height:100%}
  body{
    margin:0;
    font: 14px/1.45 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    color:var(--text);
    background: radial-gradient(1200px 600px at 10% -10%, #152232 0%, transparent 60%) , var(--bg);
    padding: 28px clamp(16px, 3vw, 32px);
  }

  h1{
    margin:0 0 14px;
    font-size: clamp(18px, 2.4vw, 26px);
    letter-spacing:.2px;
    font-weight: 650;
    background: linear-gradient(180deg, var(--text), #b8c3cf);
    -webkit-background-clip: text; background-clip: text; color: transparent;
  }

  /* ========= Toolbar ========= */
  .bar{
    display:flex; flex-wrap:wrap; gap:10px 12px; align-items:center;
    margin: 10px 0 16px;
    background: linear-gradient(180deg, var(--panel), var(--panel-2));
    border:1px solid var(--border);
    border-radius: calc(var(--radius) + 4px);
    padding: 10px;
    box-shadow: var(--shadow);
  }

  /* Inputs & buttons */
  .bar input[type="text"], .bar input[type="url"]{
    flex:1 1 280px; min-width: 220px; max-width: 520px;
    border:1px solid var(--border); background:#0c1117; color:var(--text);
    padding:10px 12px; border-radius:12px; outline: none;
    transition: border-color .15s, box-shadow .15s, background .15s;
  }
  .bar input[type="text"]::placeholder, .bar input[type="url"]::placeholder{ color:var(--muted) }
  .bar input[type="text"]:focus, .bar input[type="url"]:.focus, .bar input[type="url"]:focus{
    border-color: color-mix(in oklab, var(--accent) 60%, white 0%);
    box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 30%, transparent 70%);
    background:#0e141b;
  }

  .bar input[type="file"]{
    position: relative;
    padding: 10px 12px;
    border:1px dashed var(--border);
    border-radius:12px;
    background:#0c1117;
    color:var(--muted);
  }

  button{
    padding:10px 14px;
    border:1px solid color-mix(in srgb, var(--accent) 60%, #000 40%);
    background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 22%, #000 78%), #0b121a);
    color: #eaf3ff;
    border-radius:12px;
    cursor:pointer;
    transition: transform .06s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;
    box-shadow: 0 6px 16px rgba(0,0,0,.36), inset 0 -1px 0 rgba(255,255,255,.06);
  }
  button:hover{ transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,.38) }
  button:active{ transform: translateY(0); box-shadow: 0 6px 16px rgba(0,0,0,.32) }

  /* ========= Table shell ========= */
  .table-wrap{
    max-width:100%;
    overflow:auto;
    border:1px solid var(--border);
    border-radius: var(--radius);
    background: linear-gradient(180deg, var(--panel), var(--panel-2));
    box-shadow: var(--shadow);
    position: relative;
  }

  /* Scroll shadows for overflow hint */
  .table-wrap::before,
  .table-wrap::after{
    content:"";
    position: sticky; top:0; bottom:0; width:24px; pointer-events:none; z-index:1;
  }
  .table-wrap::before{ left:0; background: linear-gradient(90deg, var(--panel) 0%, transparent 100%) }
  .table-wrap::after{ right:0; background: linear-gradient(270deg, var(--panel) 0%, transparent 100%) }

  /* ========= Table ========= */
  table{ border-collapse: collapse; width:100%; font-size: 14px; }

  thead th{
    position: sticky; top:0; z-index: 2;
    background: linear-gradient(180deg, #0f141b, #0c1117);
    border-bottom:1px solid var(--border);
    color: #cfd7df;
    white-space: nowrap;
    padding: 10px 12px;
    text-align: left;
    letter-spacing:.2px;
    cursor: pointer;
    user-select: none;
  }

  /* Subtle sort indicator (neutral by default) */
  thead th::after{
    content:"";
    display:inline-block; margin-left:8px;
    width: 0; height: 0; border-left:5px solid transparent; border-right:5px solid transparent;
    border-top:6px solid #7b8794; opacity:.5; transform: translateY(-2px);
  }
  thead th:hover{ color:#ffffff }
  thead th:hover::after{ opacity:.85 }

  /* Body rows */
  tbody tr{ transition: background .12s ease, box-shadow .12s ease }
  tbody tr:nth-child(even){ background: #0c1117 }
  tbody tr:hover{
    background: #101720;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.03), inset 0 -1px 0 rgba(0,0,0,.3);
  }

  th, td{
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-soft);
    vertical-align: top;
  }

  /* Links inside cells */
  td a{
    color: var(--accent);
    text-decoration: none;
    border-bottom: 1px dashed color-mix(in srgb, var(--accent) 60%, transparent 40%);
    padding-bottom:1px;
  }
  td a:hover{
    color: color-mix(in srgb, var(--accent) 85%, white 15%);
    border-bottom-style: solid;
  }

  /* Info line */
  .muted{
    color: var(--muted);
    font-size: 12px;
    margin-top: 10px;
    padding-left: 2px;
  }
  .hidden{ display:none }

  /* ========= Compact mode on small screens ========= */
  @media (max-width: 700px){
    .bar{ padding: 8px }
    .bar input[type="text"], .bar input[type="url"]{ flex:1 1 100%; min-width: 0 }
    th, td{ padding: 9px 10px }
    table{ font-size: 13px }
  }
</style>

</head>
<body>
  <h1>Drug repurposing Viewer</h1>
  <div class="bar">
    <input id="search" type="text" placeholder="Filter rows (case-insensitive)..." />
    <input id="url" type="url" placeholder="Paste CSV URL (supports comma/semicolon/tab)"/>
    <button id="loadUrl">Load URL</button>
    <input id="file" type="file" accept=".csv,text/csv" />
  </div>
  <div class="table-wrap"><table id="tbl"><thead></thead><tbody></tbody></table></div>
  <div id="info" class="muted hidden"></div>

<script>
/* --- CSV parsing (quotes + , ; \t) --- */
function detectDelimiter(text){
  const sample = text.split(/\r?\n/).slice(0,20).join("\n");
  const counts = {",":0,";":0,"\t":0};
  for (const d of Object.keys(counts)){
    counts[d] = sample.split("\n")
      .map(line => (line.match(new RegExp(d === "\t" ? "\\t" : d.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),"g"))||[]).length)
      .reduce((a,b)=>a+b,0);
  }
  return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0] || ",";
}

function parseCSV(text, delimiter){
  delimiter = delimiter || detectDelimiter(text);
  const rows = [];
  let i=0, field="", inQuotes=false, row=[];
  while(i < text.length){
    const c = text[i], next = text[i+1];
    if (inQuotes){
      if (c === '"' && next === '"'){ field += '"'; i+=2; continue; }
      if (c === '"'){ inQuotes=false; i++; continue; }
      field += c; i++; continue;
    } else {
      if (c === '"'){ inQuotes=true; i++; continue; }
      if (c === delimiter){ row.push(field); field=""; i++; continue; }
      if (c === '\n'){ row.push(field); rows.push(row); row=[]; field=""; i++; continue; }
      if (c === '\r'){ i++; continue; }
      field += c; i++; continue;
    }
  }
  row.push(field); rows.push(row);
  if (rows.length && rows[rows.length-1].length===1 && rows[rows.length-1][0]==="") rows.pop();
  return rows;
}

/* --- State & DOM refs --- */
const tbl = document.getElementById('tbl');
const thead = tbl.querySelector('thead');
const tbody = tbl.querySelector('tbody');
const searchBox = document.getElementById('search');
const info = document.getElementById('info');

let data = [];     // array of objects
let columns = [];  // header names
let sortState = { key:null, dir:1 };

/* --- Convert rows to objects --- */
function rowsToObjects(rows){
  if (!rows.length) return {columns:[], data:[]};
  let cols = rows[0].map((h,i)=> (h && h.trim()) ? h.trim() : `col_${i+1}`);
  const seen = {};
  cols = cols.map(h => {
    const base = h || 'column';
    if (!seen[base]) { seen[base]=1; return base; }
    return `${base}_${++seen[base]}`;
  });
  const out = rows.slice(1).map(r=>{
    const obj={};
    cols.forEach((h,i)=> obj[h] = (r[i] ?? ''));
    return obj;
  });
  return {columns: cols, data: out};
}

/* --- Link helpers --- */
const rxPdbCore = /^[0-9][A-Za-z0-9]{3}$/;  // 3Q4U, 2PML
const rxEmail   = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
const rxDoi     = /^10\.\d{4,9}\/\S+$/i;

function extractPdbAndChain(raw){
  if (!raw) return null;
  const v = String(raw).trim();
  const cleaned = v.replace(/\.pdb$/i, "").replace(/^pdb[:/]/i, "").trim();
  const parts = cleaned.split(/[:._-]/).filter(Boolean);
  const pdbId = parts[0]?.toUpperCase();
  if (!pdbId || !rxPdbCore.test(pdbId)) return null;
  const chain = parts[1] && /^[A-Za-z0-9]{1,3}$/.test(parts[1]) ? parts[1] : null;
  return { pdbId, chain };
}

function makeLinkedNode(header, value){
  const td = document.createElement('td');
  const v = (value ?? "").toString().trim();
  const h = (header ?? "").toString().toLowerCase();

  if (!v){ td.textContent = ""; return td; }

  // 0) direct URL
  if (v.startsWith("http://") || v.startsWith("https://")){
    const a = document.createElement('a');
    a.href = v; a.textContent = v; a.target = "_blank"; a.rel="noopener noreferrer";
    td.appendChild(a); return td;
  }

  // 1) PubChem CID
  if (h.includes("pubchem") || (h.includes("cid") && !h.includes("acid"))){
    const a = document.createElement('a');
    a.href = `https://pubchem.ncbi.nlm.nih.gov/compound/${encodeURIComponent(v)}`;
    a.textContent = v; a.target="_blank"; a.rel="noopener noreferrer";
    td.appendChild(a); return td;
  }

  // 2) RCSB PDB for target/malaria (or any PDB-looking value)
  if (h === "target" || h === "malaria"){
    const pdb = extractPdbAndChain(v);
    if (pdb){
      const a = document.createElement('a');
      const chainParam = pdb.chain ? `?chainId=${encodeURIComponent(pdb.chain)}` : "";
      a.href = `https://www.rcsb.org/structure/${pdb.pdbId}${chainParam}`;
      a.textContent = v; a.target="_blank"; a.rel="noopener noreferrer";
      td.appendChild(a); return td;
    }
  }

  // 3) File name → NGL viewer
  if (h.includes("file name")) {
    const a = document.createElement('a');
    const viewerUrl = "./ngl/viewer.html";   // viewer page
    const pdbPath   = "../MDpdb/" + v;       // relative path (not absolute)

    const ext = v.toLowerCase().split('.').pop();
    const fmt = (ext === 'cif' || ext === 'mmcif') ? 'mmcif'
              : (ext === 'bcif') ? 'bcif'
              : (ext === 'sdf')  ? 'sdf'
              : (ext === 'mol2') ? 'mol2'
              : 'pdb';

    a.href = `${viewerUrl}?load=${encodeURIComponent(pdbPath)}&format=${encodeURIComponent(fmt)}`;
    a.textContent = v;
    a.target = "_blank";
    a.rel = "noopener noreferrer";
    td.appendChild(a);
    return td;
  }


  // 4) Gene ID → PlasmoDB
if (h.toLowerCase().includes("gene id")) {
  if (v) {
    const a = document.createElement('a');
    a.href = `https://plasmodb.org/plasmo/app/record/gene/${encodeURIComponent(v)}`;
    a.textContent = v;
    a.target = "_blank";
    a.rel = "noopener noreferrer";
    td.appendChild(a);
  } else {
    td.textContent = ""; // keep cell empty if no gene id
  }
  return td;
}


  // 5) Email
  if (rxEmail.test(v)){
    const a = document.createElement('a');
    a.href = `mailto:${v}`; a.textContent = v;
    td.appendChild(a); return td;
  }

  // 6) plain text
  td.textContent = v; return td;
}

/* --- Render --- */
function renderTable(cols, rows){
  // header
  thead.innerHTML = "";
  const tr = document.createElement('tr');
  cols.forEach(c=>{
    const th = document.createElement('th');
    th.textContent = c;
    th.title = "Click to sort";
    th.addEventListener('click', ()=> sortBy(c));
    tr.appendChild(th);
  });
  thead.appendChild(tr);

  // body
  tbody.innerHTML = "";
  const frag = document.createDocumentFragment();
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    cols.forEach(c=>{
      tr.appendChild(makeLinkedNode(c, r[c]));
    });
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);

  info.classList.remove('hidden');
  info.textContent = `${rows.length.toLocaleString()} rows  •  ${cols.length} columns`;
}

/* --- Sort & Filter --- */
function sortBy(key){
  if (sortState.key === key){ sortState.dir *= -1; } else { sortState.key = key; sortState.dir = 1; }
  const dir = sortState.dir;
  const isNum = data.every(row => row[key] === "" || !isNaN(Number(row[key])));
  const sorted = [...filteredRows()].sort((a,b)=>{
    const va = a[key], vb = b[key];
    if (isNum){ return (Number(va||0) - Number(vb||0)) * dir; }
    return String(va).localeCompare(String(vb)) * dir;
  });
  renderTable(columns, sorted);
}

function filteredRows(){
  const q = searchBox.value.trim().toLowerCase();
  if (!q) return data;
  return data.filter(row => columns.some(c => String(row[c]).toLowerCase().includes(q)));
}

/* --- Loaders --- */
async function loadFromText(text){
  const rows = parseCSV(text);
  const {columns: cols, data: rowsObj} = rowsToObjects(rows);
  columns = cols; data = rowsObj;
  renderTable(columns, filteredRows());
}

async function loadFromURL(url){
  const res = await fetch(url, {cache:'no-store'});
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const txt = await res.text();
  await loadFromText(txt);
}

document.getElementById('loadUrl').addEventListener('click', async ()=>{
  const url = document.getElementById('url').value.trim();
  if (!url) return alert("Please paste a CSV URL.");
  try { await loadFromURL(url); }
  catch (e){ alert("Failed to load URL: " + e.message); }
});

document.getElementById('file').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if (!f) return;
  const txt = await f.text();
  await loadFromText(txt);
});

searchBox.addEventListener('input', ()=>{
  renderTable(columns, filteredRows());
});

/* --- Auto load a default CSV file from the same folder as index.html --- */
window.addEventListener("DOMContentLoaded", async () => {
  try {
    await loadFromURL("./Data.csv");   // change "data.csv" to your filename
  } catch (e) {
    console.error("Failed to auto-load CSV:", e);
  }
});

</script>
</body>
</html>
